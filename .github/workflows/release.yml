name: Publish

on:
  push:
    branches: [master]

jobs:
  test:
    if: github.actor != 'renovate[bot]'
    uses: ./.github/workflows/test.yml

  meta:
    if: github.actor != 'renovate[bot]'
    name: Package Meta
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.packages.outputs.packages }}
    steps:
      - name: Checkout project
        uses: actions/checkout@v5

      - name: Find package names
        id: packages
        shell: python
        run: | # python
          import json
          import os
          packages = []
          with os.scandir('packages') as it:
            for entry in it:
              if entry.is_dir():
                packages.append(entry.name)
          output = {}
          for package in packages:
            with open(f'packages/{package}/deno.json', 'r') as deno:
              output[package] = json.load(deno).get('name')
          with open(os.environ['GITHUB_OUTPUT'], 'a') as gho:
            gho.write(f'packages={json.dumps(output)}')

  publish:
    name: Publish
    needs: [meta, test]
    runs-on: ubuntu-latest
    concurrency:
      group: release
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.PUSH_TOKEN }}

      - uses: denoland/setup-deno@v2
        with:
          deno-version-file: .dvmrc

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
        run: | # python
          import json
          import subprocess
          for package, package_name in json.loads('${{ needs.meta.outputs.packages }}').items():
            subprocess.run(
              ['npm', 'install', 'semantic-release-monorepo', '@semantic-release/exec', '@semantic-release/git'],
              check=True,
              cwd=f'packages/{package}'
            )
            subprocess.run(
              ['npx', 'semantic-release', '--tag-format=' + package_name + '-v${version}'],
              check=True,
              cwd=f'packages/{package}'
            )
