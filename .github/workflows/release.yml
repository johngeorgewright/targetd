name: Publish

on:
  push:
    branches: [master]

jobs:
  test:
    if: github.actor != 'renovate[bot]'
    uses: ./.github/workflows/test.yml

  meta:
    if: github.actor != 'renovate[bot]'
    name: Package Meta
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.packages.outputs.packages }}
    steps:
      - name: Checkout project
        uses: actions/checkout@v5

      - name: Find package names
        id: packages
        run: | # shell
          output='{}'
          for package in $(ls packages); do
            name=$(cat "packages/${package}/deno.json" | jq .name)
            output=$(echo $output | jq -c ". += {\"${package}\":${name}}")
          done
          echo "packages=${output}" >> $GITHUB_OUTPUT

  publish:
    name: Publish
    needs: [meta, test]
    runs-on: ubuntu-latest
    concurrency:
      group: release
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.PUSH_TOKEN }}

      - uses: denoland/setup-deno@v2
        with:
          deno-version-file: .dvmrc

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
        run: | # shell
          for x in $(echo '${{ needs.meta.outputs.packages }}' | jq -cr '. | to_entries | .[]'); do
            package=$(echo $x | jq -r .key)
            package_name=$(echo $x | jq -r .value)
            echo '{}' > packages/${package}/package.json
            npm install semantic-release-monorepo @semantic-release/exec @semantic-release/git
            npx semantic-release
          done 
