name: Publish

on:
  push:
    branches: [master]

jobs:
  test:
    if: github.actor != 'renovate[bot]'
    uses: ./.github/workflows/test.yml

  packages:
    if: github.actor != 'renovate[bot]'
    name: Package Meta
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.packages.outputs.packages }}
    steps:
      - name: Checkout project
        uses: actions/checkout@v5

      - name: Find packages
        id: packages
        run: | # shell
          packages=$(ls packages | jq -R -s -c 'split("\n")[:-1]')
          echo "packages=${packages}" >> $GITHUB_OUTPUT

  publish:
    name: Publish
    needs: [packages, test]
    runs-on: ubuntu-latest
    concurrency:
      group: release
    strategy:
      max-parallel: 1
      matrix:
        package: ${{ fromJSON(needs.packages.outputs.packages) }}
    steps:
      - name: Checkout project
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.PUSH_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      # cycjimmy/semantic-release-action doesn't want to install this.
      - working-directory: packages/${{ matrix.package }}
        run: npm i semantic-release-monorepo @semantic-release/exec @semantic-release/git

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
        with:
          working_directory: packages/${{ matrix.package }}
